name: Continuous Deploy

on:
  push:
    branches: [main, master]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.github/workflows/docs.yml'
      - '.claude/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  IS_CI: yes
  ORG_GRADLE_PROJECT_RELEASE_MODE: false

jobs:
  publish-snapshot:
    name: Publish SNAPSHOT
    runs-on: ubuntu-latest
    steps:
      - name: Skip if commit message contains [skip ci]
        if: contains(github.event.head_commit.message, '[skip ci]')
        run: |
          echo "Skipping CI due to [skip ci] in commit message"
          exit 0

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment

      - name: Convert version to SNAPSHOT
        run: |
          # Read current version (e.g., 1.0.0-alpha01)
          CURRENT_VERSION=$(grep "version=" gradle.properties | cut -d'=' -f2)
          echo "üì¶ Original version: $CURRENT_VERSION"

          # Convert to SNAPSHOT using our script
          kotlin .github/scripts/bump-version.main.kts snapshot

          # Verify SNAPSHOT was added
          SNAPSHOT_VERSION=$(grep "version=" gradle.properties | cut -d'=' -f2)
          echo "üîÑ SNAPSHOT version: $SNAPSHOT_VERSION"

          if [[ ! "$SNAPSHOT_VERSION" =~ -SNAPSHOT$ ]]; then
            echo "‚ùå ERROR: Failed to add SNAPSHOT suffix"
            exit 1
          fi
          echo "‚úÖ Ready to publish SNAPSHOT version: $SNAPSHOT_VERSION"

      - name: Publish SNAPSHOT to Maven Central
        run: |
          ./gradlew publishAllPublicationsToMavenCentralRepository --no-daemon
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          # GPG signing variables (not required for SNAPSHOT but keeping for safety)
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_SIGNING_PASSWORD }}

      - name: Report success
        run: |
          VERSION=$(grep "version=" gradle.properties | cut -d'=' -f2)
          echo "üöÄ Successfully published $VERSION to Maven Central"
          echo "No GitHub Release created for SNAPSHOT versions"