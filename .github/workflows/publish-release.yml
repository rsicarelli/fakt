name: Publish Release

on:
  workflow_dispatch:
    inputs:
      bump:
        required: true
        type: choice
        description: 'Version bump type'
        default: 'minor'
        options:
          - major
          - minor
          - patch
      release_type:
        required: true
        type: choice
        description: 'Release type'
        default: 'alpha'
        options:
          - alpha
          - beta
          - stable

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  IS_CI: yes
  ORG_GRADLE_PROJECT_RELEASE_MODE: true

jobs:
  validation:
    name: Run Validations
    runs-on: ubuntu-latest
    steps:
      - name: Fail if branch is not main
        if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master'
        run: |
          echo "This workflow should only be triggered from main/master branch"
          exit 1

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment

      - name: Run Ktlint
        uses: ./.github/actions/validate-ktlint

      - name: Run Detekt
        uses: ./.github/actions/validate-detekt

      - name: Run Spotless
        uses: ./.github/actions/validate-spotless

      - name: Run License Check
        uses: ./.github/actions/validate-licenses

      - name: Run Tests
        uses: ./.github/actions/run-tests

      - name: Test Samples
        uses: ./.github/actions/test-samples

  publish:
    name: Publish to Maven Central
    runs-on: ubuntu-latest
    needs: validation
    outputs:
      version_published: ${{ steps.published.outputs.version }}
      version_new: ${{ steps.bump.outputs.version_new }}
    steps:
      - name: Create GitHub App Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}

      - name: Setup Environment
        uses: ./.github/actions/setup-environment

      - name: Configure Git
        run: |
          git config --global user.name 'fakt-bot'
          git config --global user.email 'bot@rsicarelli.dev'

      - name: Publish to Maven Central
        run: |
          ./gradlew publishAndReleaseToMavenCentral --no-daemon
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_SIGNING_PASSWORD }}

      - name: Capture Published Version
        id: published
        run: |
          CURRENT=$(grep "version=" gradle.properties | cut -d'=' -f2)
          echo "version=$CURRENT" >> $GITHUB_OUTPUT
          echo "tag=v$CURRENT" >> $GITHUB_OUTPUT

      - name: Sync Documentation with Published Version
        run: |
          kotlin .github/scripts/sync-docs-version.main.kts ${{ steps.published.outputs.version }}

      - name: Commit Published Version State
        run: |
          git add docs/ samples/ README.md gradle-plugin/README.md gradle/libs.versions.toml
          if ! git diff --cached --quiet; then
            git commit -m "docs: sync to published version ${{ steps.published.outputs.version }}"
          else
            echo "No documentation changes to commit"
          fi

      - name: Bump Version
        id: bump
        run: |
          kotlin .github/scripts/bump-version.main.kts ${{ inputs.bump }} ${{ inputs.release_type }}

      - name: Sync Documentation for Development
        run: |
          kotlin .github/scripts/sync-docs-version.main.kts ${{ steps.bump.outputs.version_new }}

      - name: Commit Next Development Version
        run: |
          git add gradle.properties gradle/libs.versions.toml docs/ samples/ README.md gradle-plugin/README.md
          if ! git diff --cached --quiet; then
            git commit -m "chore: bump to next development version ${{ steps.bump.outputs.version_new }}"
          else
            echo "No changes to commit"
          fi

      - name: Create and Push Tag
        run: |
          git tag ${{ steps.published.outputs.tag }}
          git push origin ${{ steps.published.outputs.tag }}

      - name: Create GitHub Release
        uses: ./.github/actions/create-github-release
        with:
          tag: ${{ steps.published.outputs.tag }}
          github-token: ${{ steps.app-token.outputs.token }}

      - name: Bump to Next SNAPSHOT
        id: bump-snapshot
        run: |
          # Read current version (e.g., 1.3.0)
          CURRENT=$(grep "version=" gradle.properties | cut -d'=' -f2)
          # Add -SNAPSHOT
          NEXT="${CURRENT}-SNAPSHOT"
          # Update gradle.properties
          sed -i "s/version=$CURRENT/version=$NEXT/" gradle.properties
          echo "next_snapshot=$NEXT" >> $GITHUB_OUTPUT

      - name: Commit Next SNAPSHOT
        run: |
          git add gradle.properties
          git commit -m "chore: bump to ${{ steps.bump-snapshot.outputs.next_snapshot }} [skip ci]"
          git push origin HEAD

  deploy-docs:
    name: Deploy Release Documentation
    needs: publish
    permissions:
      contents: write
      pages: write
      id-token: write
    uses: ./.github/workflows/deploy-docs.yml
    with:
      version: ${{ needs.publish.outputs.version_published }}
      alias: 'latest'
      set-default: true
